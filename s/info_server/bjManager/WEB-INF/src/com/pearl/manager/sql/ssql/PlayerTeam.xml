<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="PlayerTeam">

 	<!-- Use type aliases to avoid typing the full classname every time. -->
 	<typeAlias alias="PlayerTeam" type="com.pearl.manager.pojo.PlayerTeam"/> 	

	<resultMap id="selectResult" class="PlayerTeam">
		<result property="id" column="ID"/>
		<result property="playerId" column="PLAYER_ID"/>
		<result property="teamId" column="TEAM_ID"/>
		<result property="job" column="JOB"/>
		<result property="killNum" column="KILL"/>
		<result property="deadNum" column="DEAD"/>
		<result property="approved" column="APPROVED"/>
		<result property="createTime" column="CREATED_TIME"/>
		<result property="score" column="SCORE"/>
		<result property="assist" column="ASSIST"/>
		<result property="contribution" column="CONTRIBUTION"/>
		<result property="times" column="TIMES"/>
		<result property="point" column="POINT"/>
	</resultMap>
	
	
	<select id="select" parameterClass="java.util.Map" resultMap="selectResult">
		select 
			pt.ID,
			pt.PLAYER_ID,
			pt.TEAM_ID,
			pt.JOB,
			pt.KILL,
			pt.DEAD,
			pt.APPROVED,
			UNIX_TIMESTAMP(pt.CREATED_TIME) as CREATED_TIME,
			pt.SCORE,
			pt.ASSIST,
			pt.CONTRIBUTION,
			pt.TIMES,
			pt.POINT
		from PLAYER_TEAM pt
		where 
		<dynamic prepend="    ">
			<isNotNull prepend="and" property="fid">
				pt.TEAM_ID=#fid# 
			</isNotNull>
		</dynamic>	
		order by pt.JOB desc;
	</select>

	<select id="selectById" parameterClass="java.lang.Integer" resultMap="selectResult">
		select 
			pt.ID,
			pt.PLAYER_ID,
			pt.TEAM_ID,
			pt.JOB,
			pt.KILL,
			pt.DEAD,
			UNIX_TIMESTAMP(pt.CREATED_TIME) as CREATED_TIME,
			pt.APPROVED,
			pt.SCORE,
			pt.ASSIST,
			pt.CONTRIBUTION,
			pt.TIMES,
			pt.POINT
		from PLAYER_TEAM pt
		where pt.PLAYER_ID=#id#
	</select>
	
	<insert id="insert" parameterClass="PlayerTeam">
		insert into PLAYER_TEAM (PLAYER_ID,TEAM_ID,JOB,`KILL`,DEAD,CREATED_TIME,APPROVED) 
		values(#playerId#,#teamId#,#job#,#killNum#,#deadNum#,now(),#approved#);
		<selectKey resultClass="int" keyProperty="id">
			SELECT @@IDENTITY AS ID
		</selectKey>
	</insert>
	
	<update id="update" parameterClass="PlayerTeam" >
		update PLAYER_TEAM 
			set TEAM_ID = #teamId#,
				JOB = #job#,
				`KILL` = #killNum#,
				DEAD = #deadNum#,
				APPROVED = #approved#,
				CREATED_TIME = now(),
				SCORE = #score#,
				ASSIST = #assist#,
				CONTRIBUTION = #contribution#,
				TIMES = #times#,
				POINT = #point#
		where ID = #id#
	</update>
	
	<delete id="delete" parameterClass="PlayerTeam" >
		delete from PLAYER_TEAM where PLAYER_ID = #playerId# and TEAM_ID = #teamId#  
	</delete>
	
	<update id="updateApply" parameterClass="java.util.Map" >
		update PLAYER_TEAM 
			set TEAM_ID = #teamId#,
				 CREATED_TIME = now()
		where PLAYER_ID = #id# and APPROVED != 'Y' 
	</update>
	
	
	<update id="approveApply" parameterClass="java.util.Map" >
		update PLAYER_TEAM 
			set 
			 	`KILL` = #player.GKill#,
			 	DEAD = #player.GDead#,
			 	APPROVED = 'Y'
			where PLAYER_ID = #player.id# and TEAM_ID = #teamId# and APPROVED = 'N'
	</update>
	
	
	<update id="updateJob" parameterClass="java.util.Map">
		update PLAYER_TEAM
			set JOB = #newJob#
		where PLAYER_ID = #id# and APPROVED = 'Y'  
	</update>
	
	
	<delete id="remove" parameterClass="java.util.Map" >
		delete from PLAYER_TEAM where PLAYER_ID = #playerId# and TEAM_ID = #teamId#  
	</delete>
	
	
	<delete id="removeAllApplication" parameterClass="java.lang.Integer" >
		delete from PLAYER_TEAM where PLAYER_ID = #playerId# and APPROVED != 'Y'  
	</delete>
</sqlMap>